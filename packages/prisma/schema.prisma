datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x", "linux-musl-openssl-3.0.x", "debian-openssl-3.0.x"]
}

enum UserRole {
  admin
  user
}

model User {
  id          String       @id
  email       String       @unique
  name        String
  password    String
  role        UserRole     @default(user)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  chats       Chat[]
  folders     Folder[]
  jobs        Job[]
  integrations Integration[]
  settings    Settings?

  videos      Video[]
  projects    Project[]
  collections Collection[]
  exports     Export[]
}

model Settings {
  id     String @id
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  primaryFaceLabel         String?
  
  notifyOnJobComplete Boolean @default(true)
  notifyOnErrors      Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum FolderStatus {
  idle
  scanning
  indexed
  error
}

model Folder {
  id          String       @id
  path        String       @unique
  status      FolderStatus @default(idle)
  videoCount  Int?
  lastScanned DateTime?
  createdAt   DateTime     @default(now())
  jobs        Job[]
  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  watcherEnabled    Boolean  @default(true)
  lastWatcherScan   DateTime?
  excludePatterns   String[] @default(["*.part", "*.temp"])
  includePatterns   String[] @default(["*.mp4", "*.mov", "*.avi", "*.mkv"])

  videos Video[]
}

enum JobStatus {
  pending
  processing
  done
  error
}

enum JobStage {
  starting
  transcribing
  frame_analysis
  creating_scenes
  embedding_text
  embedding_visual
  embedding_audio
}

model Job {
  id              String    @id
  videoPath       String
  thumbnailPath   String?
  fileSize        BigInt    @default(0)
  overallProgress Int       @default(0)
  progress        Int       @default(0)
  stage           JobStage  @default(starting)
  status          JobStatus @default(pending)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @default(now())
  folderId        String?
  folder          Folder?   @relation(fields: [folderId], references: [id])
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  
  frameAnalysisTime Int?  
  sceneCreationTime Int?  
  transcriptionTime Int?   
  textEmbeddingTime Int?  
  audioEmbeddingTime Int?  
  visualEmbeddingTime Int?

  frameAnalysisPlugins Json?
  frameAnalysisStages Json?
}

enum Sender {
  user
  assistant
}

model Chat {
  id         String        @id
  title      String?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  userId     String
  user       User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages   ChatMessage[]
  isLocked   Boolean       @default(false)
  lockReason String?

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])
}

enum MessageIntent {
 compilation 
 analytics 
 general 
 refinement 
 similarity
}

enum MessageStage {
  understanding   
  searching       
  analyzing       
  compiling       
  refining   
  stitching
  exporting_scenes     
}


model ChatMessage {
  id                String   @id
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  sender            Sender
  text              String?
  chatId            String
  chat              Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  outputSceneIds    String[] @default([])
  stitchedVideoPath String?
  tokensUsed        BigInt   @default(0)
  isError           Boolean  @default(false)

  isThinking       Boolean  @default(false)

  stage            MessageStage? 

  intent           MessageIntent?

  exportId            String? @unique
  export              Export?     @relation(fields: [exportId], references: [id], onDelete: Cascade)

  @@index([chatId, createdAt])
}

enum IntegrationType {
  Immich
}

model Integration {
  id            String   @id
  userId        String   
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type          IntegrationType @default(Immich)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  config       Json?

  @@unique([type, userId])
  @@index([type, userId])
}

model Project {
  id           String   @id
  name         String
  instructions String @db.VarChar(5000)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  videos       Video[]
  isArchived   Boolean  @default(false)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  chats Chat[]
}

model Video {
  id        String   @id
  source    String
  name      String
  duration  BigInt   @default(0)
  importAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  shottedAt DateTime

  thumbnailUrl String
  faces        Json?
  emotions     Json?
  shotTypes    Json?
  objects      Json?

  aspectRatio String? @default("16:9")

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  folderId  String?
  folder    Folder?    @relation(fields: [folderId], references: [id], onDelete: Cascade)

  projects        Project[]
  collectionItems CollectionItem[]

  @@unique([source, userId])
}

enum CollectionType {
  visual_style
  subject_matter
  emotional_tone
  aspect_ratio
  time_of_day
  use_case
  people
  location
  custom
  geographic_location
  person
  b_roll
  audio
}

enum CollectionStatus {
  active
  archived
  processing
}

model Collection {
  id          String         @id
  name        String
  description String?
  type        CollectionType

  isAutoPopulated   Boolean @default(true)
  autoUpdateEnabled Boolean @default(true)

  status        CollectionStatus @default(active)
  itemCount     Int              @default(0)
  totalDuration BigInt           @default(0)
  lastUpdated   DateTime         @default(now())

  thumbnailUrl String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  items CollectionItem[]

  exports Export[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, type])
  @@index([userId, status])
  @@index([type, status])

  @@index([type, name])

  @@unique([userId, type, name])
}

model CollectionItem {
  id String @id

  videoId  String
  video    Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  sceneIds String[] @default([])

  confidence Float
  matchType  String @default("embedding")

  viewCount   Int       @default(0)
  exportCount Int       @default(0)
  lastUsed    DateTime?

  isPinned  Boolean @default(false)
  userNotes String?

  collectionId String
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  addedAt   DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([collectionId, videoId])
  @@index([collectionId, confidence])
  @@index([videoId])
}

enum ExportStatus {
  created
  ready
  processing
  failed
}

model Export {
  
  id String @id

  status ExportStatus @default(created)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  sceneIds String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt


  chatMessage   ChatMessage?

  collectionId String?
  collection   Collection? @relation(fields: [collectionId], references: [id], onDelete: Cascade)


  name String?
  filePath String?
  progress Int @default(0)
  downloadCount Int @default(0)

  thumbnailUrl String?

  @@index([userId, status])
}