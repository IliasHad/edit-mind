ARG NODE_VERSION=22.20.0
ARG PNPM_VERSION=10.20.0

FROM node:${NODE_VERSION}-bookworm-slim AS base

ARG PNPM_VERSION

ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
RUN corepack enable && corepack prepare pnpm@${PNPM_VERSION} --activate

RUN apt-get update && apt-get install -y --no-install-recommends \
  openssl \
  ca-certificates \
  curl \
  && rm -rf /var/lib/apt/lists/*

FROM base AS dependencies

WORKDIR /app

COPY pnpm-workspace.yaml pnpm-lock.yaml package.json prisma.config.ts .npmrc ./
COPY apps/web/package.json ./apps/web/
COPY packages/shared/package.json ./packages/shared/
COPY packages/db/package.json ./packages/db/
COPY packages/ui/package.json ./packages/ui/
COPY packages/vector/package.json ./packages/vector/
COPY packages/ai/package.json ./packages/ai/
COPY packages/immich/package.json ./packages/immich/
COPY packages/media-utils/package.json ./packages/media-utils/
COPY packages/search/package.json ./packages/search/
COPY packages/smart-collections/package.json ./packages/smart-collections/
COPY packages/prisma/schema.prisma ./packages/prisma/

RUN --mount=type=cache,id=pnpm,target=/pnpm/store \
  pnpm install --frozen-lockfile

FROM dependencies AS builder

WORKDIR /app

COPY --from=dependencies /app/node_modules ./node_modules

COPY pnpm-workspace.yaml pnpm-lock.yaml package.json prisma.config.ts .npmrc ./
COPY apps ./apps
COPY packages ./packages
COPY tsconfig.json ./
COPY .npmrc ./
COPY prisma.config.ts ./
COPY turbo.json ./

RUN pnpm run build 

RUN pnpm rebuild @tailwindcss/oxide rollup

RUN pnpm --filter web build

FROM base AS production

WORKDIR /app

COPY --from=dependencies /app/node_modules ./node_modules

COPY --from=builder /app/pnpm-workspace.yaml ./
COPY --from=builder /app/pnpm-lock.yaml ./
COPY --from=builder /app/package.json ./
COPY --from=builder /app/prisma.config.ts ./
COPY --from=builder /app/tsconfig.json ./
COPY --from=builder /app/.npmrc ./

COPY --from=builder /app/apps/web/package.json ./apps/web/
COPY --from=builder /app/packages/shared/package.json ./packages/shared/
COPY --from=builder /app/packages/db/package.json ./packages/db/
COPY --from=builder /app/packages/prisma/package.json ./packages/prisma/
COPY --from=builder /app/packages/prisma/schema.prisma ./packages/prisma


COPY --from=builder /app/packages/prisma ./packages/prisma
COPY --from=builder /app/packages/shared ./packages/shared
COPY --from=builder /app/packages/db ./packages/db
COPY --from=builder /app/apps/web ./apps/web

ENV NODE_ENV=production
EXPOSE ${PORT}

CMD ["sh", "-c", "\
  pnpm --filter prisma migrate:deploy && \
  pnpm --filter prisma seed && \
  pnpm --filter web start --host 0.0.0.0 --port ${PORT} \
  "]



FROM dependencies AS development

WORKDIR /app

COPY --from=dependencies /app/node_modules ./node_modules

COPY apps/ ./apps/
COPY packages/ ./packages/
COPY turbo.json ./
COPY tsconfig.json ./

RUN pnpm --filter prisma generate

ENV NODE_ENV=development

EXPOSE 4000

CMD ["sh", "-c", "\
  pnpm --filter prisma migrate:deploy && \
  pnpm --filter prisma seed && \
  pnpm --filter web dev --host 0.0.0.0 --port ${PORT}  \
  "]

FROM base AS testing


WORKDIR /app

COPY --from=dependencies /app/node_modules ./node_modules

COPY --from=builder /app/pnpm-workspace.yaml ./
COPY --from=builder /app/pnpm-lock.yaml ./
COPY --from=builder /app/package.json ./
COPY --from=builder /app/prisma.config.ts ./
COPY --from=builder /app/tsconfig.json ./
COPY --from=builder /app/.npmrc ./

COPY --from=builder /app/apps/web/package.json ./apps/web/
COPY --from=builder /app/packages/shared/package.json ./packages/shared/
COPY --from=builder /app/packages/db/package.json ./packages/db/
COPY --from=builder /app/packages/prisma/package.json ./packages/prisma/
COPY --from=builder /app/packages/prisma/schema.prisma ./packages/prisma


COPY --from=builder /app/packages/prisma ./packages/prisma
COPY --from=builder /app/packages/shared ./packages/shared
COPY --from=builder /app/packages/db ./packages/db
COPY --from=builder /app/apps/web ./apps/web


ENV NODE_ENV=testing

CMD ["pnpm", "--filter", "ai", "test"]
